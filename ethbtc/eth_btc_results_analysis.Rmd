---
title: "Analysis of ETH-WBTC Results"
author: "Charliemarketplace"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r, warning = FALSE, message = FALSE}
library(reactable)
library(ggplot2)
library(plotly)
library(dplyr)
source("../key_functions.R")
```

# Data 

Using the accounting results detailed in `ethbtc_retroactive.Rmd` and merging them 
with metadata from unique Uniswap v3 positions available in `ethbtc_lp_actions.rds` (as detailed 
in `collect_ethbtc_data.R`) to understand any patterns in Uniswap v3 positions profitability.

- unique_id: The Uniswap v3 unique position, typically an NF_TOKEN_ID but for Vaults that 
don't use NF_TOKEN_ID, the concatenation of NF_POSITION_MANAGER--TICK_LOWER--TICK_UPPER.

- pnl_btc_terms: The profit and loss of a position over its lifecycle as measured in BTC, i.e., 
did the position increase its value in BTC terms after adjusting for BTC's price changes (in ETH) and the AMM strategy, including fees accrued.

- pnl_eth_terms: The profit and loss of a position over its lifecycle as measured in ETH, i.e., 
did the position increase its value in ETH terms after adjusting for ETH's price changes (in BTC) and the AMM strategy, including fees accrued.

- hodl_btc_terms: The value of the original assets in BTC terms at time of position closure.

- hodl_eth_terms: The value of the original assets in ETH terms at time of position closure.

- strat_btc_terms: The value of the assets removed from the position in BTC terms at time of position closure including fees acrrued.

- strat_eth_terms: The value of the assets removed from the position in ETH terms at time of position closure including fees acrrued.

```{r}
lps <- readRDS("ethbtc_lp_actions.rds")

# adding back unique_ids to get tick information 

lps$unique_id <- lps$NF_TOKEN_ID

custom_index <- which(is.na(lps$unique_id))

lps[custom_index, "unique_id"] <- paste0(lps[custom_index, "NF_POSITION_MANAGER_ADDRESS"],
                                                "--",
                                                lps[custom_index, "TICK_LOWER"],
                                                "--",
                                                lps[custom_index, "TICK_UPPER"])

swaps <- readRDS("ethbtc_swaps.rds")
ethbtc <- readRDS("ethbtc_results.rds")
ethbtc_accounts <- readRDS("post_ethbtc_accounting.rds")

ethbtc[ , 2:7] <- ethbtc[ , 2:7] %>% round(., 4)

reactable(ethbtc[200, ])

```

# Rates of Profitability

Different positions will have different profit & loss (PnL), different original assets value at position closure (HODL Reference Value, i.e., Opportunity Cost), and different withdrawn assets value at position closure including fees (Strategy Reference Value, i.e., Realized Value).

These assets are volatile, so pure PnL may not be the desired framework for assessing whether 
participating in Uniswap v3 was a *good idea*. This is where Economic Profit Percent comes in. Economic Profit is the return on investment above the opportunity cost (here, doing nothing and not having participated in Uniswap v3).

## PnL 

Because of how AMMs work, over the lifespan of a position the relative value of ETH and BTC will determine the final makeup of the assets withdrawn. If ETH goes up in value against BTC, 
positions will sell their ETH and accumulate BTC. Profit & Loss integrates price changes 
to identify the change in value over time.

### Example Table of Labels 

To better detail the labels, here is a sample table explaining 
how Breakeven, Profit, and Loss are applied in nuanced situations.

```{r}
reactable(
  data.frame(
    pnl_btc_terms = c(-1, -1, -1, 0, 0,  0, 1, 0,  1),
    pnl_eth_terms = c(-1,  0,  1, -1, 0, 1, 1, 1, -1)
  ) %>% mutate(
    pnl = case_when(
      pnl_btc_terms == 0 & pnl_eth_terms == 0 ~ "Breakeven",
      pnl_btc_terms <= 0 & pnl_eth_terms <= 0 ~ "Both PnL Loss",
      pnl_btc_terms > 0 & pnl_eth_terms <= 0 ~ "BTC PnL Only",
      pnl_btc_terms <= 0 & pnl_eth_terms > 0 ~ "ETH PnL Only",
      pnl_btc_terms > 0 & pnl_eth_terms > 0 ~ "Both PnL Profit"
    )
  )
)
```

### Actual Results

```{r}
ethbtc <- ethbtc %>% mutate(
  pnl = case_when(
    pnl_btc_terms == 0 & pnl_eth_terms == 0 ~ "Breakeven",
    pnl_btc_terms <= 0 & pnl_eth_terms <= 0 ~ "Both PnL Loss",
    pnl_btc_terms > 0 & pnl_eth_terms <= 0 ~ "BTC PnL Only",
    pnl_btc_terms <= 0 & pnl_eth_terms > 0 ~ "ETH PnL Only",
    pnl_btc_terms > 0 & pnl_eth_terms > 0 ~ "Both PnL Profit"
  )
)

key_barchart <- function(result, xlab = "Result", ylab = "Count", title){
  r <- as.data.frame(table(result))
  r$percent <- round(r$Freq/sum(r$Freq) * 100, digits = 2)
  
  plot_ly(r, x = ~result, y = ~Freq, type = "bar", text = ~paste0(percent,"%")) %>% 
    layout(
      title = list(text = title, y = 0.975),
      xaxis = list(title = xlab),
      yaxis = list(title = ylab)
    )
}
```

In general, positions gained in at least 1 form of PnL: 

- `r round(sum(ethbtc$pnl == "BTC PnL Only")/nrow(ethbtc) * 100, 2)`% of positions net increased their value in *only* BTC terms. After accounting for price changes, they effectively sold ETH for BTC.

- `r round(sum(ethbtc$pnl == "ETH PnL Only")/nrow(ethbtc) * 100, 2)`% of positions net increased their value in *only* ETH terms. After accounting for price changes, they effectively sold BTC for ETH.

- `r round(sum(ethbtc$pnl == "Both PnL Profit")/nrow(ethbtc) * 100, 2)`% of positions net increased their value in *both* ETH and BTC terms. They were undoubtedly profitable (although technically the counterfactual of going *all in* on the winning asset is not assessed here).

- `r round(sum(ethbtc$pnl %in% c("Both PnL Loss", "Breakeven"))/nrow(ethbtc) * 100, 2)`% of positions 
either broke even (often quickly withdrawing the same position without accruing any fees) or were undoubtedly unprofitable. This worst case scenario would occur from withdrawing assets specifically 
after a large price change without accruing fees to make up for the loss from price impact.
 
```{r}

key_barchart(ethbtc$pnl, title = "Position Resulting Profit & Loss Category")

```

## Strategy > HODL

PnL is useful, but in general what most interests Uniswap v3 participants is 
whether participating in the strategy beats the *opportunity cost* of not participating.

If I start with 10 BTC and 50 ETH and end up with 15.25 BTC and 40.1 ETH after withdrawing from a strategy and collecting my fees- am I better off?

PnL integrates price changes like traditional accounting. HODL Reference Value and Strategy 
Reference Value use a single point in time price (the price as of Position Closure) to assess 
whether results from a strategy exceeds opportunity cost.

```{r}
ethbtc <- ethbtc %>% mutate(
  strat = case_when(
    strat_btc_terms == hodl_btc_terms & strat_eth_terms == hodl_eth_terms ~ "Breakeven",
    strat_btc_terms <= hodl_btc_terms & strat_eth_terms <= hodl_eth_terms ~ "Both Strategy Loss",
    strat_btc_terms > hodl_btc_terms & strat_eth_terms <= hodl_eth_terms ~ "BTC Strat Gain Only",
    strat_btc_terms <= hodl_btc_terms & strat_eth_terms > hodl_eth_terms ~ "ETH Strat Gain Only",
    strat_btc_terms > hodl_btc_terms & strat_eth_terms > hodl_eth_terms ~ "Both Strategy Profit"
  )
)

```

Because PnL accounts for price changes, middling results are more common. When using a point in 
time price like Strategy vs HODL, binary results should be more common. We see: 

- `r round(sum(ethbtc$strat == "Both Strategy Profit")/nrow(ethbtc) * 100, 2)`% of positions were in total profit in both terms after accounting for fees relative to simply holding the deposited assets.
- `r round(sum(ethbtc$strat == "Both Strategy Loss")/nrow(ethbtc) * 100, 2)`% of positions were in total loss, they would have been better off in both assets having held their original deposits.

```{r}
key_barchart(ethbtc$strat, xlab = "Result", "Count", title = "Distribution of ETHBTC Strategy vs HODL")
```

## Economic Profit Percent (Strategy - HODL) / HODL

The distribution of how much profiteers profited is important for understanding how to 
replicate these results. In each asset terms the Strategy Value - the HODL Value, divided by the 
HODL value, times 100 to get to percentage, is considered the Economic Profit Percent (EPP) which is 
measured in both BTC and ETH terms separately.

```{r}
ethbtc <- ethbtc %>% mutate(
  btc_epp =  100*(strat_btc_terms - hodl_btc_terms)/hodl_btc_terms,
  eth_epp =  100*(strat_eth_terms - hodl_eth_terms)/hodl_eth_terms
)

# make breakevens 0 in case of divide by 0

ethbtc[is.na(ethbtc)] <- 0

ethbtc_sig_change <- ethbtc %>% 
  filter(btc_epp > 1 | btc_epp < -1) %>% 
  filter(eth_epp > 1 | eth_epp < -1)

```

- `r sum(ethbtc$btc_epp > 1 | ethbtc$btc_epp < -1)` of the `rnrow(ethbtc)` (
`r round(sum(ethbtc$btc_epp > 1 | ethbtc$btc_epp < -1)/nrow(ethbtc) * 100, 2)`)
had their BTC denominated Strategy Value within -1% to 1% from their HODL value.
- There is a `r cor(ethbtc$btc_epp, ethbtc$eth_epp)` correlation between Economic Profit in ETH terms and 
BTC terms. This makes sense as generally a strategy is either net winning or net losing given a single point in time 
price.

Looking at positions with a significant change (larger than 1% difference between the Strategy Value and HODL value in either direction and either asset) shows a range of `r min(ethbtc_sig_change$eth_epp)`% to `r max(ethbtc_sig_change$eth_epp)`% in ETH Economic Profit with an average `r mean(ethbtc_sig_change$eth_epp)`% 
change in value.

```{r}
key_histogram <- function(tbl, percent_col1, percent_col2,
                          p1name, p2name, xlab = "Result", ylab = "Count",
                          title){
  plot_ly(alpha = 0.45, data = tbl, 
          nbinsx = 100, 
          x = tbl[[percent_col1]],
          type = "histogram",
          name = p1name) %>%
  add_histogram(x = tbl[[percent_col2]], name = p2name) %>%   
      layout(
        barmode = "overlay",
      title = list(text = title, y = 0.975),
      xaxis = list(title = xlab),
      yaxis = list(title = ylab)
    )
}

key_histogram(tbl = ethbtc_sig_change,
              percent_col1 = "btc_epp", 
              percent_col2 = "eth_epp",
              p1name = "in BTC", p2name = "in ETH",
              xlab = "% Economic Profit against HODL",
              title = "Distribution of Significant % EPP Change \n (-1,1) removed")
  
```

# Position Characteristics by Profitability

Moving forward to identify characteristics of positions with (1) Significant Difference 
between Strategy and HODL values (1% or more in either direction) specifically in ETH 
terms across a variety of measures.

```{r}
get_start <- function(unique_id){
  min(ethbtc_accounts[[unique_id]]$BLOCK_NUMBER)
}

get_end <- function(unique_id){
  max(ethbtc_accounts[[unique_id]]$BLOCK_NUMBER)
}

ethbtc <- ethbtc %>% 
  group_by(unique_id) %>% 
  mutate(
    start_block = get_start(unique_id),
    end_block = get_end(unique_id)
  ) %>% 
  mutate(
    lifespan = end_block - start_block + 1
  )

ethbtc_sig_change <- ethbtc %>% 
  filter(btc_epp > 1 | btc_epp < -1) %>% 
  filter(eth_epp > 1 | eth_epp < -1)

```

## Start Block

It takes time to accrue fees, with only `r sum(ethbtc_sig_change$eth_epp >= 10 & ethbtc_sig_change$start_block >= 13917000)` positions starting in 2022 closing with 10%+ in Economic Profit Percentage; and 
 `r sum(ethbtc_sig_change$eth_epp >= 5 & ethbtc_sig_change$start_block >= 13917000)` getting 
 at least 5%.

```{r}
key_scatter <- function(tbl, x, y, xlab, ylab, title){
 
  plot_ly(tbl, x = tbl[[x]], y = tbl[[y]], type = "scatter", mode = "markers", name  = "Positions") %>% 
    layout(
      title = list(text = title, y = 0.975),
      xaxis = list(title = xlab),
      yaxis = list(title = ylab)
    )
    
}

key_scatter(ethbtc_sig_change, x = "start_block", y = "eth_epp",
            xlab = "Position Opening Block",
            ylab = "ETH % Gain over HODL",
            title = "Only 2 positions w/ >10% Gains Opened in 2022") %>% 
  add_lines(x = 13917000, y = c(-30, 30), name = "Jan 1, 2022")

```

## End Block

Again, as expected more time to accrues fees is important. A deeper dive into Lifespans 
will follow.

But curiously many of the historically closed positions were closed very recently in the data.

```{r}
plot(ecdf(ethbtc_sig_change$end_block), 
     ylab = "Cumulative % of Position Closures",
     xlab = "Position Closure Block #",
     main = "Position Closures are biased to recently")
```

```{r}

key_scatter(ethbtc_sig_change, x = "end_block", y = "eth_epp",
            xlab = "Position Closing Block",
            ylab = "ETH % Gain over HODL",
            title = "Profitability by Position Closing Block") %>% 
  add_lines(x = 13917000, y = c(-30, 30), name = "Jan 1, 2022")

```

## Lifespan

### Just In Time Liquidity 

```{r}
jit <- ethbtc[ethbtc$lifespan == 1, ]

```

For clarity on the phenomenon of Just In Time (JIT) Liquidity: of all positions 
`r sum(ethbtc$lifespan == 1)` lasted only a single block. Only `r sum(ethbtc_sig_change$lifespan == 1)` 
met the condition for significant change (Strategy was at least 1% different from HODL).

Of these JIT positions, `r sum(jit$strat == "Both Strategy Profit")` (nearly all) beat HODL. While their 
gains may be high on an annualized basis, they represent only `r round(100*nrow(jit)/nrow(ethbtc), 2)`% of 
closed positions. 

Overall, patience has been the most visually apparent winning strategy for beating HODL.

```{r}
key_scatter(ethbtc_sig_change, x = "lifespan", y = "eth_epp",
            xlab = "Lifespan in # Blocks",
            ylab = "ETH % Gain over HODL",
            title = "More time to accrue fees is critical") 
```

## Tick Width

Different pools (more specifically different fee tiers) have a different amount of 
minimum tick spacings that can be used when making a position. For ETH-BTC it is 60, thus 
all positions are a multiple of 60 ticks apart.

Dividing the tick width by this 60 gets us the tick spacing.
```{r}
ticks <- unique(lps[ , c("unique_id","TICK_LOWER", "TICK_UPPER")])
ticks <- ticks %>% mutate(tick_spacing = (TICK_UPPER - TICK_LOWER)/60)

ethbtc <- merge(ethbtc, ticks, all.x = TRUE, by = "unique_id")

ethbtc_sig_change <- ethbtc %>% 
  filter(btc_epp > 1 | btc_epp < -1) %>% 
  filter(eth_epp > 1 | eth_epp < -1)

```

Among all positions, 1000 tick spaces covers `r round(ecdf(ethbtc$tick_spacing)(1000) * 100, 2)`% of positions.

Zooming into this section, narrow ranges of < 200 tick spaces perform chaotically. 

```{r}
key_scatter(tbl = ethbtc, x = "tick_spacing", y = "eth_epp", 
            xlab = "Tick Spaces",
            ylab = "ETH % Gain over HODL",
            title = "Few Losers among 400+ Tick Spaces Wide") %>% 
  layout(
    xaxis = list(range = c(0, 1000))
  )

```

Comparing performance of positions under 200 tick spaces versus 200+ shows this stark contrast.   

```{r}
reactable(
  ethbtc %>% group_by(wider_than_200 = tick_spacing >= 200) %>% summarise(
    count = n(),
    min_gain = min(eth_epp), 
    median_gain = median(eth_epp),
    avg_gain = mean(eth_epp),
    max_gain = max(eth_epp)
  ) %>% round(., 2)
)

```

Filtering out the positions non-significant changes from HODL (-1% to 1% gain) increases the distribution 
bias of gains toward wider positions. It will be interesting to dive deeper on this, as all else equal, 
narrower positions concentrate their liquidity and increase their fee revenue (at the risk of selling all 
their winning tokens sooner).

```{r}
reactable(
  ethbtc_sig_change %>% group_by(wider_than_200 = tick_spacing >= 200) %>% summarise(
    count = n(),
    min_gain = min(eth_epp), 
    median_gain = median(eth_epp),
    avg_gain = mean(eth_epp),
    max_gain = max(eth_epp)
  ) %>% round(., 2)
)

```

## Position Size

Looking at Economic Profit as it relates to the size of the position using the HODL ETH 
Value, `r 100*sum(ethbtc_sig_change$hodl_eth_terms < 100)/nrow(ethbtc_sig_change)`% of 
positions were < 100 ETH in size.

Splitting by large (100+ ETH) doesn't show much difference in typical gain (both groups lose on average). 

```{r}
reactable(
  ethbtc_sig_change %>% group_by(large = hodl_eth_terms >= 100) %>% summarise(
    count = n(),
    min_gain = min(eth_epp), 
    median_gain = median(eth_epp),
    avg_gain = mean(eth_epp),
    max_gain = max(eth_epp)
  ) %>% round(., 2)
)

```

```{r}

key_scatter(tbl = ethbtc_sig_change, x = "hodl_eth_terms", y = "eth_epp", 
            xlab = "Position Size in ETH if HODL'd", 
            ylab = "ETH % Gain over HODL",
            title = "") %>% 
  layout(
    xaxis = list(range = c(0, 500))
  )

```

## Vault Managed Positions 

Do we see Vaults, like Gamma.xyz outperform on profitability over individually managed positions?
A vault is identifiable by it's lack of NF Token ID, making its unique_id a concatenation of 
NF_POSITION_MANAGER_ADDRESS--TICK_LOWER--TICK_UPPER.

```{r}

ethbtc$vault <- ifelse(grepl("^0x", ethbtc$unique_id), "Vault", "Individual")

ethbtc_sig_change <- ethbtc %>% 
  filter(btc_epp > 1 | btc_epp < -1) %>% 
  filter(eth_epp > 1 | eth_epp < -1)
```


Curiously, although there are `r sum(ethbtc$vault == "Vault")` Vaults overall, 
only `r sum(ethbtc_sig_change$vault == "Vault")` had significant differences from HODLing the assets 
(at least 1% difference in either direction).

```{r}
reactable(
  ethbtc %>% group_by(vault == "Vault") %>% summarise(
    count = n(),
    min_gain = min(eth_epp), 
    median_gain = median(eth_epp),
    avg_gain = mean(eth_epp),
    max_gain = max(eth_epp)
  ) %>% round(., 2)
)

```

Of the vaults that did result in a difference from HODLing, they lost similar amounts 
as individual Uniswap v3 NFT Managed Positions (i.e., Individuals) on average without 
any of the rare excess wins. `r sum(ethbtc_sig_change$vault == "Vault" & ethbtc_sig_change$eth_epp >= 5)` of 
the positions managed by vaults matched or exceeded +5% of HODL compared to 
`r sum(ethbtc_sig_change$vault == "Individual" & ethbtc_sig_change$eth_epp >= 5)` individuals.

```{r}
reactable(
  ethbtc_sig_change %>% group_by(vault == "Vault") %>% summarise(
    count = n(),
    min_gain = min(eth_epp), 
    median_gain = median(eth_epp),
    avg_gain = mean(eth_epp),
    max_gain = max(eth_epp)
  ) %>% round(., 2)
)

```

```{r}
plot_ly(ethbtc_sig_change, x = ~eth_epp, color = ~vault, type = "histogram", nbinsx = 100) %>% 
  layout(
    xaxis = list(range = c(-10, 10), title = "ETH % Gain over HODL"),
    title = list(text = "Vaults generally underperform HODL \n (-1%,1%) removed", y = 0.975)
  )

```

# Is there a winning Strategy?

What would most interesting, would be to find a pattern among short lifespan positions that were profitable, since annualized the same profit percentage is better when it is accumulated in shorter time spans. 

```{r}

key_scatter(ethbtc_sig_change, x = "lifespan", y = "eth_epp",
            xlab = "Lifespan in # Blocks",
            ylab = "ETH % Gain over HODL",
            title = "More time to accrue fees is critical") %>% 
  layout(
    xaxis = list(range = c(0, 100000)),
    yaxis = list(range = c(-10, 10))
  )

```

# Elite Burst Positions











